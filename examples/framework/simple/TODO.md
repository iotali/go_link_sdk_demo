# 电烤炉模拟器改进规则

## 当前实现与期望行为的差异

### 1. 定时器与数据上报机制
**问题**: 定时器启动后，数据上报频率不正确
- **当前行为**: 无论定时器状态如何，固定每30秒上报一次数据
- **期望行为**: 
  - 正常情况下每30秒上报一次
  - 定时器启动后（remainingTime > 0），改为每2秒上报一次
  - 定时器结束后恢复到每30秒上报
- **位置**: `electric_oven.go:475-487` (statusReportingLoop)

### 2. 门状态与定时器交互
**问题**: 切换门状态不会停止定时器
- **当前行为**: 门打开只是暂停加热，定时器继续倒计时
- **期望行为**: 
  - 门打开时立即停止定时器（remainingTime = 0, timerSetting = 0）
  - 如果正在计时，触发定时器取消事件
  - 操作模式变为"暂停（门开）"
- **位置**: `electric_oven.go:319-344` (toggleDoorService)

### 3. 设定温度服务的完整性
**问题**: set_temperature服务应该更完整地模拟真实烤炉
- **当前行为**: 只是设置目标温度，简单改变操作模式
- **期望行为**:
  - 设定温度 > 0 时，自动启动加热（isRunning = true）
  - 设定温度 = 0 时，停止加热（isRunning = false）
  - 如果门是开的，不允许启动加热，返回错误
  - 立即上报状态变化
- **位置**: `electric_oven.go:261-275` (setTemperatureService)

### 4. 定时器服务的增强
**问题**: start_timer服务缺少真实逻辑
- **当前行为**: 只设置定时器值，不影响其他状态
- **期望行为**:
  - 启动定时器时，如果targetTemp = 0，自动设置默认温度（如180°C）
  - 如果门是开的，不允许启动定时器，返回错误
  - 定时器启动后立即切换到2秒上报频率
  - 定时器启动时设置operationMode为"定时加热中"
- **位置**: `electric_oven.go:277-317` (startTimerService)

### 5. 温度控制逻辑的真实性
**问题**: 温度变化不够真实
- **当前行为**: 固定速率加热/冷却
- **期望行为**:
  - 加热速率应该根据温差动态调整（温差大时快，接近目标时慢）
  - 门打开时散热速度应该更快（当前已实现）
  - 风扇应该在温度高于目标温度时继续运行以均匀温度
  - 功耗应该根据实际加热功率变化
- **位置**: `electric_oven.go:373-435` (updateTemperature)

### 6. 事件上报机制
**问题**: 事件上报格式可能不正确
- **当前行为**: 使用framework的Emit方法发送自定义事件
- **期望行为**:
  - 确保事件格式符合物模型规范
  - overheat_alarm应包含温度值和时间戳
  - timer_complete应包含完成时的状态信息
  - 新增timer_cancelled事件（门打开时触发）
- **位置**: `electric_oven.go:516-558` (triggerOverheatAlarm, reportTimerComplete)

### 7. 操作模式的完整性
**问题**: 操作模式状态机不完整
- **当前状态**: "待机", "加热中", "暂停（门开）", "定时结束", "安全停机"
- **缺失状态**:
  - "定时加热中" - 定时器运行时的特殊状态
  - "预热中" - 温度低于目标50°C时
  - "保温中" - 达到目标温度±5°C时
  - "冷却中" - 停止加热后温度仍高于50°C时

### 8. 属性联动逻辑
**问题**: 属性之间的联动关系不够完整
- **期望行为**:
  - heaterStatus应该根据温度差、门状态、定时器状态自动调整
  - fanStatus应该在加热时自动开启，停止后延迟关闭
  - powerConsumption应该实时反映所有耗电组件的总和
  - internalLight在门打开时应该自动开启

### 9. 初始化和连接处理
**问题**: 设备初始连接时的行为
- **当前行为**: 连接时立即上报所有状态
- **期望行为**:
  - 连接时检查是否有未完成的定时任务
  - 如果有异常状态（如温度过高），立即处理
  - 初始化时进行自检，确保所有传感器正常

### 10. 并发安全和性能
**问题**: 状态上报可能存在并发问题
- **当前行为**: 多个goroutine可能同时触发状态上报
- **期望行为**:
  - 实现上报队列，避免并发上报
  - 定时器运行时的2秒上报应该替代30秒上报，而不是叠加
  - 使用context正确管理goroutine生命周期

## 实施优先级

### 高优先级（影响核心功能）
1. 定时器与数据上报机制 - 影响用户体验
2. 门状态与定时器交互 - 安全相关
3. 设定温度服务的完整性 - 基本功能

### 中优先级（提升真实性）
4. 定时器服务的增强
5. 温度控制逻辑的真实性
6. 操作模式的完整性
7. 属性联动逻辑

### 低优先级（优化和完善）
8. 事件上报机制
9. 初始化和连接处理
10. 并发安全和性能

## 测试场景

每个改进完成后需要测试的场景：

1. **定时器测试**
   - 启动30分钟定时器，验证2秒上报
   - 定时器结束，验证恢复30秒上报
   - 定时器运行中打开门，验证定时器停止

2. **温度控制测试**
   - 设定180°C，验证加热启动
   - 达到目标温度，验证保温模式
   - 门打开，验证加热停止

3. **服务调用测试**
   - 门开时尝试启动定时器，验证拒绝
   - 门开时尝试设定温度，验证拒绝
   - 正常启动定时器，验证自动设置默认温度

4. **事件测试**
   - 温度超过250°C，验证过热告警
   - 定时器完成，验证完成事件
   - 门打开中断定时器，验证取消事件


可以通过一下的api测试这个

服务器是 https://deviot.know-act.com
token是 488820fb-41af-40e5-b2d3-d45a8c576eea

简述
批量设置设备属性值
api 端点 POST /api/v1/thing/setDevicesProperty
请求参数
{
  "deviceName": "sensor_123"       // 设备编码
  "pointList": [
      {
        "identifier": "temperature_limit",  //填写为物模型的标识符
        "value": "100"  //填写为需要设定的值，要和物模型的属性类型匹配
      }
    ],
}

参数	类型	是否必填	描述
deviceName	String	是	设备编码
pointList	Array<Object>	是	功能点列表

响应格式
{
  "code": 200,          // 响应代码，200 表示成功
  "errorMessage": "",   // 错误描述（如有）
  "success": true,      // 布尔值，标识是否调用成功
}