# IoT Framework TODO List

## 🔴 优先级1 - 关键问题（必须立即修复）

### 1. ✅ 修复服务调用路由机制
**状态**: 已完成
- 问题: MQTT插件错误解析topic，使用parts[5]而非parts[4]
- 修复: `pkg/framework/plugins/mqtt/mqtt_plugin.go:248`
- 结果: 服务调用现在正确路由到注册的handler

### 2. ✅ 实现RRPC远程调用支持 🚀
**状态**: 已完成
- ✅ 功能: 请求/响应模式的远程调用已实现
- ✅ Topic: `/sys/{productKey}/{deviceName}/rrpc/request/+` 订阅成功
- ✅ 响应: `/sys/{productKey}/{deviceName}/rrpc/response/{messageId}` 响应机制完整
- ✅ 集成: 成功复用现有SDK的RRPC实现
- ✅ 示例: 电烤炉已支持GetOvenStatus、SetOvenTemperature、EmergencyStop等RRPC方法
- ✅ 测试: 创建了test_rrpc.sh和test_rrpc_debug.sh测试脚本

### 3. 实现服务响应机制
**问题**: 服务调用应返回具体结果而非通用消息
- 需要: 定义ServiceResponse结构
- 支持: 成功/失败状态码、返回数据、错误信息

## 🟡 优先级2 - 核心功能（物模型完整性）

### 3. 添加事件上报功能
**状态**: ✅ 已实现
- 新增API: `ReportEvent(eventName string, data map[string]interface{})`
- 事件管道: 通过事件总线 `event.EventEventReport` 分发，MQTT插件统一上报
- 示例: 过热告警、定时器完成/取消事件
- Topic: `$SYS/{ProductKey}/{DeviceName}/event/post`

### 4. 实现批量属性设置
**需求**: 支持一次设置多个属性
- 当前: 只支持单个属性设置
- 目标: `SetProperties(props map[string]interface{})`

### 5. 完善属性获取功能
**缺失**: 缺少属性查询响应
- Topic: `$SYS/{ProductKey}/{DeviceName}/property/get`
- 响应: 返回指定属性的当前值

## 🟢 优先级3 - 设备管理

### 6. 实现影子设备（延后）
**功能**: 离线时保存期望状态
- desired: 期望状态
- reported: 实际状态
- metadata: 时间戳等元数据
- 注: 暂时延后，先实现RRPC

### 7. 添加OTA升级支持
**需求**: 框架层面的固件升级
- 下载管理
- 版本控制
- 升级状态上报

### 8. 设备分组管理
**场景**: 批量管理同类设备
- 组播消息
- 批量控制
- 状态聚合

## 🔵 优先级4 - 高级功能

### 9. 实现规则引擎集成
**功能**: 基于条件的自动化
- 条件匹配
- 动作触发
- 规则链

### 10. 添加数据持久化层
**需求**: 设备状态和历史数据存储
- 本地存储接口
- 缓存机制
- 数据恢复

### 11. 离线缓存与重传
**场景**: 网络断开时的数据处理
- 消息队列
- 自动重传
- 流控机制

### 12. 子设备管理
**场景**: 网关设备管理子设备
- 子设备注册
- 代理通信
- 拓扑管理

## ⚪ 优先级5 - 开发体验

### 13. 中间件机制
**功能**: 请求处理链
- 认证中间件
- 日志中间件
- 性能监控

### 14. 插件热加载
**需求**: 运行时加载/卸载插件
- 动态加载
- 版本管理
- 依赖检查

### 15. 配置热更新
**功能**: 无需重启更新配置
- 配置监听
- 动态刷新
- 回滚机制

### 16. 调试模式增强
**工具**: 开发调试支持
- 详细日志
- 消息追踪
- 性能分析

## 📊 进度跟踪

| 任务 | 优先级 | 状态 | 负责人 | 完成时间 |
|------|--------|------|--------|----------|
| 修复服务路由 | P1 | ✅ 已完成 | - | 2025-01-07 |
| RRPC支持 | P1 | 🔄 进行中 | - | - |
| 服务响应机制 | P1 | ⏳ 待开始 | - | - |
| 事件上报 | P2 | ⏳ 待开始 | - | - |
| 批量属性 | P2 | ⏳ 待开始 | - | - |
| 影子设备 | P3 | 📌 延后 | - | - |
| OTA支持 | P3 | ⏳ 待开始 | - | - |

## 🎯 实施计划

### Phase 1 - 修复核心问题（本周）
1. 修复服务调用路由 ✅
2. 实现RRPC远程调用
3. 实现服务响应机制
4. 添加单元测试

### Phase 2 - 完善物模型（下周）
1. 实现事件上报
2. 批量属性操作
3. 属性查询响应

### Phase 3 - 设备管理（第3周）
1. 影子设备
2. OTA基础框架
3. 设备分组

### Phase 4 - 高级功能（第4周）
1. 规则引擎
2. 数据持久化
3. 离线缓存

## 📝 注意事项

1. **兼容性**: 所有改动必须保持向后兼容
2. **测试**: 每个功能必须有对应的单元测试
3. **文档**: 更新API文档和使用示例
4. **性能**: 注意性能影响，避免阻塞操作
5. **安全**: 考虑安全性，特别是OTA和规则引擎

## 🔗 相关文档

- [框架设计文档](../FRAMEWORK.md)
- [API参考](../API.md)
- [示例代码](../../examples/framework/)
- [问题追踪](https://github.com/xxx/issues)